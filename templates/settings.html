<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .form-group.required .control-label:after {
            color: red;
            content: ' *';
            font-size: 18px;
        }

        .card {
            margin-top: 15px;
        }

    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="state == 'loading'">
        Загрузка...
    </div>
    <div v-if="state == 'dashboard'">
        <h2>Пациент: [[ info.name ]]</h2>
        <strong>Опросники</strong>
        <ul>
            <li v-for="form in patient.forms">[[ form.title ]]<br><small>[[ form.doctor_description ]]</small></li>
        </ul>

        <button class="btn btn-primary btn-sm" @click="to_create_page()">Добавить</button>

    </div>
    <div v-if="state == 'create_form'">
        <a class="btn btn-danger btn-sm" @click="back_from_create_page()">назад</a>
        <ul>
            <li v-for="error in new_form.errors">[[ error ]]</li>
        </ul>
        <div class="form">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Параметры анкеты</h5>

                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Название анкеты</strong>
                        </div>
                        <div class="col-md-8">
                            <input class="form-control" v-model="new_form.title"/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Краткое описание для врача</strong>
                        </div>
                        <div class="col-md-8">
                            <textarea class="form-control" v-model="new_form.doctor_description"></textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Описание для пациента</strong>
                        </div>
                        <div class="col-md-8">
                            <textarea class="form-control" v-model="new_form.patient_description"></textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Пациент может заполнить анкету в произвольное время</strong>
                        </div>
                        <div class="col-md-8">
                            <input type="checkbox" class="form-check" v-model="new_form.show_button"/>
                        </div>
                    </div>

                    <div class="form-group row" v-if="new_form.show_button">
                        <div class="col-md-4">
                            <strong>Название анкеты для кнопки</strong>
                        </div>
                        <div class="col-md-8">
                            <input class="form-control" v-model="new_form.button_title"/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Расписание</h5>
                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Режим</strong>
                        </div>
                        <div class="col-md-8">
                            <select @change="clear_time_points()" class="form-control"
                                    v-model="new_form.timetable.mode">
                                <option value="manual">Заполняется вручную</option>
                                <option value="daily">Ежедневно</option>
                                <option value="weekly">Еженедельно</option>
                                <option value="monthly">Ежемесячно</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="new_form.timetable.mode != 'manual'">
                        <hr>

                        <div class="form-group row" v-for="(timepoint, i) in new_form.timetable.points">
                            <div class="col-md-3">
                                <div v-if="new_form.timetable.mode == 'weekly'">
                                    <small class="text-muted">День недели</small>
                                    <select class="form-control" v-model="timepoint.day">
                                        <option v-for="(day, i) in ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье']"
                                                v-bind:value="i">[[ day ]]
                                        </option>
                                    </select>
                                </div>
                                <div v-if="new_form.timetable.mode == 'monthly'">
                                    <small class="text-muted">День</small>
                                    <input type="number" min="1" max="31" class="form-control"
                                           v-model="timepoint.day"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Часы</small>
                                <input type="number" min="0" max="23" class="form-control"
                                       v-model="timepoint.hours"/>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Минуты</small>
                                <input type="number" min="0" max="59" class="form-control"
                                       v-model="timepoint.minutes"/>
                            </div>
                            <div class="col-md-3">
                                <a href="#" @click="remove_time_point(i)" v-if="new_form.timetable.points.length > 1">Удалить</a>
                            </div>
                        </div>

                        <a href="#" class="btn btn-primary btn-sm" @click="add_time_point()">Добавить</a>

                    </div>
                </div>
            </div>

            <hr>

            <div class="card" v-for="(field, i) in new_form.fields">
                <div class="card-body">
                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Текст вопроса</strong>
                        </div>
                        <div class="col-md-8">
                            <input class="form-control" v-model="field.text"/>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Тип</strong>
                        </div>
                        <div class="col-md-8">
                            <select @change="clear_params(field)" class="form-control" v-model="field.type">
                                <option value="integer">Целое число</option>
                                <option value="float">Число с точкой</option>
                                <option value="text">Текст</option>
                                <option value="textarea">Многострочный текст</option>
                                <option value="checkbox">Галочка</option>
                                <option value="radio">Выбор варианта</option>
                                <option value="scale">Шкала</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-4">
                            <strong>Код категории</strong>
                        </div>
                        <div class="col-md-8">
                            <input class="form-control" v-model="field.category"/>
                        </div>
                    </div>

                    <div v-if="field.type == 'integer'">
                        <hr>
                        <div class="form-group row">
                            <div class="col-md-4">
                                <strong>Ограничения</strong>
                            </div>
                            <div class="col-md-3">
                                От <input type="number" pattern="\d*" class="form-control" v-model="field.params.min"/>
                            </div>
                            <div class="col-md-3">
                                до <input type="number" pattern="\d*" class="form-control" v-model="field.params.max"/>
                            </div>
                        </div>
                    </div>

                    <div v-if="field.type == 'float'">
                        <hr>
                        <div class="form-group row">
                            <div class="col-md-4">
                                <strong>Ограничения</strong>
                            </div>
                            <div class="col-md-3">
                                От <input type="number" step="0.01" class="form-control" v-model="field.params.min"/>
                            </div>
                            <div class="col-md-3">
                                до <input type="number" step="0.01" class="form-control" v-model="field.params.max"/>
                            </div>
                        </div>
                    </div>

                    <div v-if="field.type == 'radio'">
                        <hr>

                        <strong>Варианты ответа</strong>

                        <div class="form-group row" v-for="(variant, j) in field.params.variants">
                            <div class="col-md-4">
                                <small class="text-mutted">Код категории</small><br>
                                <input type="text" class="form-control" v-model="variant.category"/>
                            </div>
                            <div class="col-md-6">
                                <small class="text-mutted">Текст варианта</small><br>
                                <input type="text" class="form-control" v-model="variant.text"/>
                            </div>
                            <a href="#" v-if="field.params.variants.length > 1" @click="remove_variant(field, j)">Удалить
                                вариант</a>
                        </div>
                        <a class="btn btn-primary btn-sm" @click="add_variant(field)">Добавить вариант</a>

                    </div>

                    <a class="btn btn-danger btn-sm" @click="remove_field(i)">Удалить вопрос</a>
                </div>
            </div>

            <p class="text-center"><a href="#" class="btn btn-primary btn-sm" @click="add_field()">Добавить поле</a></p>
        </div>

        <button class="btn btn-success btn-lg" @click="save_new_form()">Сохранить</button>

    </div>


</div>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            state: "loading",
            info: {},
            contract: {},
            patient: {},
            new_form: {}
        },
        methods: {
            load: function () {
                axios.get('{{ urls.load | safe }}').then(this.process_load_answer);
            },
            process_load_answer: function (response) {
                this.info = response.data.info;
                this.contract = response.data.contract;
                this.patient = response.data.patient;
                this.state = 'dashboard'
            },
            to_create_page: function () {
                this.state = 'create_form';
                this.new_form = {
                    fields: [],
                    timetable: {
                        mode: 'daily',
                        points: []
                    },
                    errors: []
                };
                this.add_time_point()
            },
            back_from_create_page: function () {
                this.state = 'dashboard';
            },
            clear_params: function (field) {
                field.params = {};

                if (field.type == 'radio') {
                    field.params.variants = [{text: '', category: ''}]
                }
            },
            clear_time_points: function () {
                this.new_form.timetable.points = []
                this.add_time_point();
            },
            add_field: function () {
                this.new_form.fields.push({
                    type: 'integer',
                    params: {}
                });
            },
            add_variant: function (field) {
                field.params.variants.push({text: '', category: ''});
                this.$forceUpdate()
            },
            remove_variant: function (field, index) {
                field.params.variants.splice(index, 1);
                this.$forceUpdate()
            },
            remove_field: function (index) {
                this.new_form.fields.splice(index, 1);
            },
            add_time_point: function () {
                if (this.new_form.timetable.mode == 'manual') {
                    return;
                }
                if (this.new_form.timetable.mode == 'daily') {
                    this.new_form.timetable.points.push({
                        hour: '',
                        minute: ''
                    })
                } else {
                    this.new_form.timetable.points.push({
                        day: '',
                        hour: '',
                        minute: ''
                    })
                }
            },
            remove_time_point: function (index) {
                this.new_form.timetable.points.splice(index, 1);
            },
            check_new_form: function () {
                this.new_form.errors = [];
                if (!this.new_form.title) {
                    this.new_form.errors.push('Укажите название анкеты')
                }
                if (this.new_form.show_button && !this.new_form.button_title) {
                    this.new_form.errors.push('Укажите название для кнопки')
                }
                if (this.new_form.timetable.mode != 'manual') {
                    let prepare_point = (point) => {
                        point.hour = parseInt(point.hour);
                        point.minutes = parseInt(point.minutes);

                        if (point.day) point.day = parseInt(point.day);
                    }
                    let general_validate = (point) => {
                        if (!point.hours || !point.minutes) return true;
                        if (point.hours < 0 || point.hours > 23) return true;
                        if (point.minutes < 0 || point.minutes > 59) return true;
                    }
                    let validate_point = general_validate;
                    if (this.new_form.timetable.mode == 'weekly') {
                        validate_point = (point) => {
                            if (general_validate(point)) return true;
                            if (!point.day || point.day < 0 || point.day > 6) return true;
                        }
                    }
                    if (this.new_form.timetable.mode == 'monthly') {
                        validate_point = (point) => {
                            if (general_validate(point)) return true;
                            if (!point.day || point.day < 1 || point.day > 31) return true;
                        }
                    }

                    if (this.new_form.timetable.points.filter(point => validate_point(point)).length > 0) {
                        this.new_form.errors.push('Проверьте корректность расписания')
                    }
                }

                if (this.new_form.fields.length == 0) {
                    this.new_form.errors.push('Добавьте хотя бы один вопрос')
                }

                if (this.new_form.errors.length != 0)
                {
                    return false;
                }
                else {
                    return true;
                }

            },
            save_new_form: function () {
                this.check_new_form();
            }

        },
        mounted: function () {
            this.load();
        },
        delimiters: ['[[', ']]'],
    })


</script>
</body>
</html>